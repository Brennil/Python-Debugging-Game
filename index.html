<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Error Corrector Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .code-font { font-family: 'Fira Code', monospace; }
        .code-line-container { display: flex; align-items: center; padding: 0.125rem 0.5rem; border-radius: 0.375rem; border: 2px solid transparent; transition: background-color 0.2s, border-color 0.2s; }
        .line-number { width: 2em; text-align: right; margin-right: 1em; color: #6b7280; user-select: none; }
        .clickable .code-line-container:hover { background-color: #374151; }
        .clickable .code-line-container { cursor: pointer; }
        .selected { border-color: #38bdf8; background-color: #1e3a8a; }
        #answer-input:focus { border-color: #22d3ee; box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.3); outline: none; }
        #progress-snake { position: relative; }
        #snake-head { width: 24px; height: 24px; background-color: #10b981; border-radius: 50%; position: absolute; right: -2px; top: 50%; transform: translateY(-50%); display: flex; align-items: center; justify-content: center; gap: 4px; border: 2px solid #047857; z-index: 10; }
        .eye { width: 4px; height: 4px; background-color: black; border-radius: 50%; }
        .tongue { 
            position: absolute; 
            width: 8px; 
            height: 2px; 
            background-color: #ef4444; 
            left: 100%;
            top: 50%; 
            transform: translateY(-50%); 
            border-radius: 0 2px 2px 0; 
            animation: flick 1.5s infinite ease-in-out; 
            transform-origin: left;
        }
        .tongue::after { 
            content: ''; 
            position: absolute; 
            right: -2px; 
            top: -1px; 
            width: 4px; 
            height: 4px; 
            background-color: #ef4444; 
            clip-path: polygon(100% 50%, 0 0, 0 100%);
        }
        @keyframes flick { 
            0%, 20%, 100% { 
                transform: translateY(-50%) scaleX(1); 
            } 
            10% { 
                transform: translateY(-50%) scaleX(0); 
            } 
        }
        #timer-bar { transition: width 0.1s linear; }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto">
        <!-- Start Screen -->
        <div id="start-screen" class="bg-gray-800 rounded-xl shadow-2xl p-8 text-center">
            <h1 class="text-4xl font-bold text-cyan-400 mb-4">Python Error Corrector</h1>
            <p class="text-gray-300 mb-8">Find and fix errors in Python code. The faster you answer, the higher your score!</p>
            <button id="start-btn" class="bg-white text-gray-800 font-semibold py-3 px-6 rounded-lg shadow-lg flex items-center justify-center mx-auto transition-transform transform hover:scale-105">
                <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px" height="48px"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.904,36.338,44,30.65,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                Sign in with Google
            </button>
        </div>

        <!-- Game Container -->
        <div id="game-container" class="hidden">
            <div class="bg-gray-800 rounded-xl shadow-2xl p-6 md:p-8">
                <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-cyan-400">Python Error Corrector</h1>
                        <p id="user-display" class="text-sm text-gray-400"></p>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-400">Score</div>
                        <div id="score" class="text-2xl font-bold">0</div>
                    </div>
                </div>
                <div id="question-counter" class="text-center text-gray-400 mb-2 font-medium">Question 1 of 10</div>
                <div class="w-full bg-gray-700 rounded-full h-4 mb-2 border-2 border-gray-600">
                    <div id="progress-snake" class="bg-gradient-to-r from-emerald-400 to-cyan-500 h-full rounded-l-full transition-all duration-500 ease-out" style="width: 0%"><div id="snake-head"><div class="eye"></div><div class="eye"></div><div class="tongue"></div></div></div>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2.5 mb-6"><div id="timer-bar" class="bg-yellow-400 h-2.5 rounded-full" style="width: 100%"></div></div>
                <p id="instructions" class="text-center text-gray-300 mb-6">1. Click the line of code with the error.</p>
                <div id="code-snippet-wrapper" class="bg-gray-900 rounded-lg p-4 mb-4"><pre><code id="code-snippet" class="text-sm md:text-base leading-relaxed code-font"></code></pre></div>
                <div id="answer-area" class="mt-4 hidden"><div class="flex flex-col sm:flex-row gap-2"><input type="text" id="answer-input" class="code-font w-full bg-gray-700 text-white border-2 border-gray-600 rounded-lg py-3 px-4" placeholder="2. Now, type the corrected line..."><button id="submit-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">Submit</button></div></div>
                <div id="feedback-container" class="min-h-[80px] mt-4 p-4 rounded-lg flex-col justify-center items-center text-center hidden"><p id="feedback-message" class="text-lg font-semibold"></p><p id="explanation" class="mt-2 text-gray-300 whitespace-pre-wrap"></p></div>
                <div id="button-container" class="mt-6 text-center"><button id="next-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105 hidden">Next Question</button></div>
            </div>
        </div>
        
        <!-- Final Score Modal -->
        <div id="final-score-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden">
            <div class="bg-gray-800 rounded-xl shadow-2xl p-8 text-center transform scale-95 transition-transform">
                <h2 class="text-3xl font-bold mb-2 text-cyan-400">Game Over!</h2>
                <p class="text-gray-300 mb-4">Your final score is:</p>
                <p id="final-score" class="text-6xl font-bold mb-8">0</p>
                <button id="restart-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105">Play Again</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // This placeholder will be replaced by the GitHub Actions workflow
        const firebaseConfig = JSON.parse('__FIREBASE_CONFIG__');

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- DOM Element References ---
        const startScreen = document.getElementById('start-screen');
        const startBtn = document.getElementById('start-btn');
        const gameContainer = document.getElementById('game-container');
        const userDisplay = document.getElementById('user-display');
        const codeSnippetEl = document.getElementById('code-snippet');
        const scoreEl = document.getElementById('score');
        const nextBtn = document.getElementById('next-btn');
        const restartBtn = document.getElementById('restart-btn');
        const feedbackContainer = document.getElementById('feedback-container');
        const feedbackMessageEl = document.getElementById('feedback-message');
        const explanationEl = document.getElementById('explanation');
        const finalScoreModal = document.getElementById('final-score-modal');
        const finalScoreEl = document.getElementById('final-score');
        const questionCounterEl = document.getElementById('question-counter');
        const answerInput = document.getElementById('answer-input');
        const submitBtn = document.getElementById('submit-btn');
        const progressSnakeEl = document.getElementById('progress-snake');
        const timerBarEl = document.getElementById('timer-bar');

        // --- Expanded Game Data ---
        const allCodeSnippets = [
            // Syntax Errors
            { id: 'syn-01', code: 'def greet(name)\n    print("Hello, " + name)', errorLine: 1, correctLineText: 'def greet(name):', explanation: 'Syntax Error: A function definition must end with a colon (:).' },
            { id: 'syn-02', code: 'x = 10\nif x = 5:\n    print("x is 5")', errorLine: 2, correctLineText: 'if x == 5:', explanation: 'Syntax Error: Use "==" for comparison. A single "=" is for assignment.' },
            { id: 'syn-03', code: 'print("Hello, World!)', errorLine: 1, correctLineText: 'print("Hello, World!")', explanation: 'SyntaxError: The string is missing a closing quote (").' },
            { id: 'syn-04', code: 'items = [1, 2, 3\nprint(items)', errorLine: 1, correctLineText: 'items = [1, 2, 3]', explanation: 'SyntaxError: The list is missing a closing bracket (]).' },
            { id: 'syn-05', code: 'for i in range(10)\n    print(i)', errorLine: 1, correctLineText: 'for i in range(10):', explanation: 'Syntax Error: A for loop statement must end with a colon (:).' },
            { id: 'syn-06', code: 'x = 1\nelse:\n    x = 2', errorLine: 2, correctLineText: 'if False:', explanation: 'SyntaxError: An "else" statement must be preceded by an "if" or "elif" block.' },
            { id: 'syn-07', code: 'my_func(a=1, 2)', errorLine: 1, correctLineText: 'my_func(1, a=2)', explanation: 'SyntaxError: A positional argument cannot follow a keyword argument.' },
            { id: 'syn-08', code: 'class MyClass\n    pass', errorLine: 1, correctLineText: 'class MyClass:', explanation: 'SyntaxError: A class definition must end with a colon (:).' },
            { id: 'syn-09', code: 'name = "Alice"\nprint(f"Hello, {name")', errorLine: 2, correctLineText: 'print(f"Hello, {name}")', explanation: 'SyntaxError: An f-string is missing its closing curly brace (}).' },
            { id: 'syn-10', code: 'try:\n    x = 1/0\nexcept ZeroDivisionError\n    print("Error")', errorLine: 3, correctLineText: 'except ZeroDivisionError:', explanation: 'SyntaxError: An "except" clause must end with a colon (:).' },

            // Indentation Errors
            { id: 'ind-01', code: 'def my_function():\nprint("Indented")', errorLine: 2, correctLineText: '    print("Indented")', explanation: 'IndentationError: The body of a function must be indented.' },
            { id: 'ind-02', code: 'for i in range(3):\n    print(i)\n print("Done")', errorLine: 3, correctLineText: 'print("Done")', explanation: 'IndentationError: This line has an unexpected indentation level.' },
            { id: 'ind-03', code: 'if True:\n  x = 5\n    y = 10', errorLine: 3, correctLineText: '  y = 10', explanation: 'IndentationError: Unexpected indent. Lines in the same block must have the same indentation.' },
            
            // Name Errors
            { id: 'nam-01', code: 'message = "Hi"\nprint(mesage)', errorLine: 2, correctLineText: 'print(message)', explanation: 'NameError: The variable "mesage" is not defined. Check for typos.' },
            { id: 'nam-02', code: 'import math\narea = MATH.pi * r**2', errorLine: 2, correctLineText: 'area = math.pi * r**2', explanation: 'NameError: "MATH" is not defined. Module names are case-sensitive.' },
            { id: 'nam-03', code: 'def calculate():\n    total = 100\nprint(total)', errorLine: 3, correctLineText: 'calculate()', explanation: 'NameError: The variable "total" is local to the function and cannot be accessed outside.' },
            { id: 'nam-04', code: 'Print("Hello")', errorLine: 1, correctLineText: 'print("Hello")', explanation: 'NameError: The function "Print" is not defined. Function names are case-sensitive.' },

            // Type Errors
            { id: 'typ-01', code: 'age = 30\nprint("Age: " + age)', errorLine: 2, correctLineText: 'print("Age: " + str(age))', explanation: 'TypeError: Cannot concatenate a string and an integer. Convert the integer to a string first.' },
            { id: 'typ-02', code: 'count = len(12345)', errorLine: 1, correctLineText: 'count = len("12345")', explanation: 'TypeError: The len() function does not work on integers. It works on sequences like strings, lists, etc.' },
            { id: 'typ-03', code: 'for i in 10:\n    print(i)', errorLine: 1, correctLineText: 'for i in range(10):', explanation: 'TypeError: An integer is not iterable. You need to loop over a sequence, like range(10).' },
            { id: 'typ-04', code: 'my_set = {1, 2, 3}\nprint(my_set[0])', errorLine: 2, correctLineText: 'print(1 in my_set)', explanation: "TypeError: Sets are unordered and don't support indexing. Use the 'in' keyword to check for membership." },
            { id: 'typ-05', code: 'import math\nprint(math.pi())', errorLine: 2, correctLineText: 'print(math.pi)', explanation: "TypeError: 'float' object is not callable. `math.pi` is a value, not a function, so remove the parentheses." },
            { id: 'typ-06', code: 'def add(a,b):\n    return a+b\nresult=add(5)', errorLine: 3, correctLineText: 'result=add(5, 0)', explanation: 'TypeError: Missing required argument. The function expects two arguments but only got one.', validationRegex: '^result\\s*=\\s*add\\s*\\(\\s*5\\s*,\\s*-?\\d+(\\.\\d+)?\\s*\\)\\s*(#.*)?$' },
            { id: 'typ-07', code: 'data = None\nprint(data["key"])', errorLine: 2, correctLineText: 'if data is not None:', explanation: "TypeError: Cannot access items from a 'NoneType' object. Always check if an object is None before using it." },

            // Index Errors
            { id: 'idx-01', code: 'my_list = [1, 2, 3]\nprint(my_list[3])', errorLine: 2, correctLineText: 'print(my_list[2])', explanation: 'IndexError: List index out of range. The last item is at index 2.' },
            { id: 'idx-02', code: 'word = "Python"\nlast_char = word[6]', errorLine: 2, correctLineText: 'last_char = word[5]', explanation: 'IndexError: String index out of range. Indices are 0-based, so the last character is at index 5.' },
            
            // Key Errors
            { id: 'key-01', code: 'd = {"k": "v"}\nprint(d["key"])', errorLine: 2, correctLineText: 'print(d["k"])', explanation: 'KeyError: The key "key" does not exist in the dictionary.' },
            { id: 'key-02', code: 'person = {"name": "John"}\nprint(person["age"])', errorLine: 2, correctLineText: 'print(person.get("age"))', explanation: 'KeyError: The key "age" is not in the dictionary. Using .get("age") is a safer way to access keys.' },
            
            // Attribute Errors
            { id: 'att-01', code: 'x = 5\nx.append(1)', errorLine: 2, correctLineText: 'my_list = [5]', explanation: "AttributeError: 'int' object has no attribute 'append'. Append is a method for lists." },
            { id: 'att-02', code: 'my_string = "hello"\nmy_string.sort()', errorLine: 2, correctLineText: 'sorted_string = sorted(my_string)', explanation: "AttributeError: 'str' object has no attribute 'sort'. Sorting is done with the sorted() function for strings." },
            
            // Value Errors
            { id: 'val-01', code: 'number = int("abc")', errorLine: 1, correctLineText: 'number = int("123")', explanation: 'ValueError: Cannot convert a non-numeric string like "abc" to an integer.' },
            { id: 'val-02', code: 'a, b = [1, 2, 3]', errorLine: 1, correctLineText: 'a, b, c = [1, 2, 3]', explanation: 'ValueError: Too many values to unpack. The number of variables must match the number of items in the list.' },
            
            // Zero Division Errors
            { id: 'zer-01', code: 'result = 100 / 0', errorLine: 1, correctLineText: 'result = 100 / 1', explanation: 'ZeroDivisionError: Cannot divide by zero.' },

            // Logical Errors (Code runs but logic is flawed)
            { id: 'log-01', code: 'i = 0\nwhile i < 5:\n    print(i)', errorLine: 3, correctLineText: '    i += 1', explanation: 'Logical Error: This is an infinite loop because the counter "i" is never incremented.' },
            { id: 'log-02', code: '# x should be no more than 5\nx = 10\nif x > 5:\n    pass', errorLine: 3, correctLineText: 'if x <= 5:', explanation: 'Logical Error: "No more than 5" means less than or equal to 5 (<=).' },
            { id: 'log-03', code: 'role = "guest"\nif role == "admin" or "editor":\n    print("Access Granted")', errorLine: 2, correctLineText: 'if role == "admin" or role == "editor":', explanation: 'Logical Error: `"editor"` is a non-empty string, which is always `True`. You must compare `role` to each value.' },
            { id: 'log-04', code: '# price must be at least 20\nprice = 15\nif price > 20:\n    pass', errorLine: 3, correctLineText: 'if price >= 20:', explanation: 'Logical Error: "At least 20" means greater than or equal to 20 (>=).' },
            { id: 'log-05', code: 'numbers = [1, 2, 3]\nnumbers = numbers.append(4)', errorLine: 2, correctLineText: 'numbers.append(4)', explanation: 'Logical Error: The `.append()` method modifies the list in-place and returns `None`.' },
            { id: 'log-06', code: 'def double(nums):\n    for n in nums:\n        return n * 2', errorLine: 3, correctLineText: '        print(n*2)', explanation: 'Logical Error: `return` exits the function on the first loop. The loop will never complete.' },
            { id: 'log-07', code: '# user must not be "guest"\nuser = "admin"\nif user == "guest":\n    pass', errorLine: 3, correctLineText: 'if user != "guest":', explanation: 'Logical Error: To check if a user is NOT "guest", use the not equal operator (!=).' },
            { id: 'log-08', code: 'if x == 1 or x == 2 and y == 3:', errorLine: 1, correctLineText: 'if (x == 1 or x == 2) and y == 3:', explanation: 'Logical Error: `and` has higher precedence than `or`. Use parentheses to group conditions correctly.' },
            { id: 'log-09', code: 'my_list = [1, 1, 2, 3]\nunique_items = set(list)', errorLine: 2, correctLineText: 'unique_items = set(my_list)', explanation: "Logical Error: You are converting the built-in type `list` to a set, not your variable `my_list`." },
            { id: 'log-10', code: 'def change(val):\n    val = 10\nx=5\nchange(x)\n# now x should be 10', errorLine: 2, correctLineText: '    return 10', explanation: 'Logical Error: Integers are immutable. The function changes its local copy, not the original variable.' },
            
            // Miscellaneous common mistakes
            { id: 'misc-01', code: 'my_dict = {\n"key" = "value"\n}', errorLine: 2, correctLineText: '"key": "value"', explanation: 'SyntaxError: Use a colon (:) to separate keys and values in a dictionary, not an equals sign (=).' },
            { id: 'misc-02', code: 'my_tuple = (1, 2, 3)\nmy_tuple[0] = 0', errorLine: 2, correctLineText: 'my_list = list(my_tuple)', explanation: "TypeError: Tuples are immutable and their items cannot be changed after creation." },
            { id: 'misc-03', code: 'if "a" in "apple":\n    print("Found it!")\nelse if "b" in "banana":\n    print("Found that!")', errorLine: 3, correctLineText: 'elif "b" in "banana":', explanation: 'SyntaxError: In Python, the correct keyword is `elif`, not `else if`.' },
            { id: 'misc-04', code: 'numbers = [1,2,3]\nmore_numbers = (4,5,6)\nall_numbers = numbers + more_numbers', errorLine: 3, correctLineText: 'all_numbers = numbers + list(more_numbers)', explanation: "TypeError: You can only concatenate a list with another list, not a tuple." },
            { id: 'misc-05', code: 'def my_func(items=[]):\n    items.append(1)\n    return items', errorLine: 1, correctLineText: 'def my_func(items=None):', explanation: "Logical Error: Using a mutable type like a list as a default argument can cause unexpected behavior across function calls." }
        ];

        // --- Game State ---
        let currentQuestions = [];
        let currentSnippetIndex = 0;
        let score = 0;
        let lineSelected = false;
        let timerInterval;
        let questionStartTime;
        let studentName = '';
        let userId = null;
        const QUESTION_TIME_LIMIT = 15000;
        const MAX_SCORE_PER_QUESTION = 100;

        // --- Game Functions ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        async function recordAnswer(questionId, isCorrect, points, timeTaken) {
            try {
                if (!userId) return; // Don't record if not signed in
                await addDoc(collection(db, "game_sessions"), {
                    userId: userId,
                    studentName: studentName,
                    questionId: questionId,
                    isCorrect: isCorrect,
                    score: points,
                    timeTakenMs: timeTaken,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error("Error writing document: ", error);
            }
        }

        function loadSnippet(index) {
            lineSelected = false;
            const snippet = currentQuestions[index];
            codeSnippetEl.innerHTML = snippet.code.split('\n').map((line, i) => `<div class="code-line-container" data-line="${i + 1}"><span class="line-number">${i + 1}</span><span>${line}</span></div>`).join('');
            questionCounterEl.textContent = `Question ${index + 1} of ${currentQuestions.length}`;
            document.getElementById('instructions').textContent = '1. Click the line of code with the error.';
            document.getElementById('code-snippet-wrapper').classList.add('clickable');
            feedbackContainer.classList.add('hidden');
            document.getElementById('answer-area').classList.add('hidden');
            nextBtn.classList.add('hidden');
            submitBtn.disabled = false;
            answerInput.disabled = false;
            answerInput.value = '';
            const progressPercent = (index / currentQuestions.length) * 100;
            progressSnakeEl.style.width = `${progressPercent}%`;
            clearInterval(timerInterval);
            timerBarEl.style.width = '100%';
            questionStartTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - questionStartTime;
                const remainingPercent = Math.max(0, (QUESTION_TIME_LIMIT - elapsed) / QUESTION_TIME_LIMIT * 100);
                timerBarEl.style.width = `${remainingPercent}%`;
                if (elapsed >= QUESTION_TIME_LIMIT) handleTimesUp();
            }, 100);
        }

        function handleTimesUp() {
            clearInterval(timerInterval);
            submitBtn.disabled = true;
            answerInput.disabled = true;
            const currentSnippet = currentQuestions[currentSnippetIndex];
            const feedbackText = `Time's up!\nThe correct line was: \`${currentSnippet.correctLineText.trim()}\``;
            showFeedback(false, feedbackText);
            recordAnswer(currentSnippet.id, false, 0, QUESTION_TIME_LIMIT);
            if (currentSnippetIndex < currentQuestions.length - 1) {
                nextBtn.classList.remove('hidden');
            } else {
                progressSnakeEl.style.width = '100%';
                setTimeout(showFinalScore, 2500);
            }
        }
        
        function handleLineClick(e) {
            if (lineSelected) return;
            const lineDiv = e.target.closest('.code-line-container');
            if (!lineDiv) return;
            lineSelected = true;
            lineDiv.classList.add('selected');
            
            const lineText = lineDiv.querySelector('span:last-child').textContent;
            answerInput.value = lineText.trim();
            
            document.getElementById('instructions').textContent = '2. Now, type the corrected line of code.';
            document.getElementById('code-snippet-wrapper').classList.remove('clickable');
            document.getElementById('answer-area').classList.remove('hidden');
            answerInput.focus();
        }

        async function checkAnswer() {
            clearInterval(timerInterval);
            const timeTaken = Date.now() - questionStartTime;
            submitBtn.disabled = true;
            answerInput.disabled = true;

            const currentSnippet = currentQuestions[currentSnippetIndex];
            const userAnswerText = answerInput.value.trim();
            const correctLineText = currentSnippet.correctLineText.trim();
            const selectedLineNumber = lineSelected ? parseInt(document.querySelector('.selected').dataset.line) : -1;

            let isCorrect = false;
            let points = 0;

            if (selectedLineNumber === currentSnippet.errorLine) {
                let isTextCorrect = false;
                if (currentSnippet.validationRegex) {
                    const regex = new RegExp(currentSnippet.validationRegex);
                    isTextCorrect = regex.test(userAnswerText);
                } else {
                    // Normalize by removing all whitespace for flexible comparison
                    isTextCorrect = userAnswerText.replace(/\s/g, '') === correctLineText.replace(/\s/g, '');
                }

                if (isTextCorrect) {
                    isCorrect = true;
                    points = Math.floor(Math.max(10, MAX_SCORE_PER_QUESTION * ((QUESTION_TIME_LIMIT - timeTaken) / QUESTION_TIME_LIMIT)));
                    score += points;
                    scoreEl.textContent = score;
                    showFeedback(true, `+${points} points! ${currentSnippet.explanation}`);
                } else {
                    showFeedback(false, `You found the right line, but the correction is incorrect.\nCorrect example: \`${correctLineText}\``);
                }
            } else {
                showFeedback(false, `That's not the line with the error.\nThe error is on line ${currentSnippet.errorLine}: \`${currentSnippet.explanation}\``);
            }
            
            await recordAnswer(currentSnippet.id, isCorrect, points, timeTaken);

            if (currentSnippetIndex < currentQuestions.length - 1) {
                nextBtn.classList.remove('hidden');
            } else {
                progressSnakeEl.style.width = '100%';
                setTimeout(showFinalScore, 2500);
            }
        }
        
        function showFeedback(isCorrect, explanation) {
            feedbackMessageEl.textContent = isCorrect ? 'Correct!' : 'Not Quite!';
            explanationEl.textContent = explanation;
            feedbackContainer.classList.remove('hidden', 'bg-red-900', 'bg-emerald-900');
            feedbackContainer.classList.add(isCorrect ? 'bg-emerald-900' : 'bg-red-900');
        }

        function showFinalScore() {
            finalScoreEl.textContent = score;
            finalScoreModal.classList.remove('hidden');
            finalScoreModal.firstElementChild.classList.add('scale-100');
            if (typeof confetti === 'function') {
                confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
            }
        }

        function initializeGame() {
            shuffleArray(allCodeSnippets);
            currentQuestions = allCodeSnippets.slice(0, 10);
            currentSnippetIndex = 0;
            score = 0;
            scoreEl.textContent = '0';
            userDisplay.textContent = `Student: ${studentName}`;
            loadSnippet(currentSnippetIndex);
            finalScoreModal.classList.add('hidden');
        }

        // --- Event Listeners ---
        startBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider)
                .then((result) => {
                    const user = result.user;
                    userId = user.uid;
                    studentName = user.displayName;
                    
                    startScreen.classList.add('hidden');
                    gameContainer.classList.remove('hidden');
                    initializeGame();
                }).catch((error) => {
                    console.error("Google sign-in error", error);
                    if (error.code === 'auth/unauthorized-domain') {
                        const currentDomain = window.location.hostname;
                        alert(`Authentication Error: The domain '${currentDomain}' is not authorized for Google Sign-In.\n\nPlease go to your Firebase Console -> Authentication -> Settings -> Authorized domains, and add this domain to the list.`);
                    } else {
                        alert("Could not sign in with Google. Please check the console for more details.");
                    }
                });
        });

        codeSnippetEl.addEventListener('click', handleLineClick);
        submitBtn.addEventListener('click', checkAnswer);
        answerInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !submitBtn.disabled) checkAnswer(); });
        nextBtn.addEventListener('click', () => {
            currentSnippetIndex++;
            if (currentSnippetIndex < currentQuestions.length) loadSnippet(currentSnippetIndex);
        });
        restartBtn.addEventListener('click', () => {
            finalScoreModal.classList.add('hidden');
            gameContainer.classList.add('hidden');
            startScreen.classList.remove('hidden');
        });
    </script>
</body>
</html>

